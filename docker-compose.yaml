version: "3.7"
services:
  php:
    build:
      args:
        user: ${USR}
        uid: 1001
      context: ./
      dockerfile: Dockerfile
    image: php-${PREFIX_NAME}-8.0
    container_name: ${PREFIX_NAME}-php
    restart: unless-stopped
    working_dir: /var/www/
    ports:
      - ${PHP_PORT}:9000
    volumes:
      - ./src:/var/www
    networks:
      - ${RED_NAME}
    depends_on:
      - postgres
      - mysql
  
  mysql:
    image: mysql:8.0
    container_name: ${PREFIX_NAME}-mysql
    restart: unless-stopped
    ports:
      - ${MY_PORT}:3306
    environment:
      MYSQL_DATABASE: ${MY_DB}
      MYSQL_ROOT_PASSWORD: ${MY_ROOT_PASS}
      MYSQL_PASSWORD: ${MY_USR_PASS}
      MYSQL_USER: ${MY_USR_NAME}
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
    volumes:
      - ./supports/mysql/entrypoint:/docker-entrypoint-initdb.d
      - ./supports/mysql/data:/var/lib/mysql
    networks:
      - ${RED_NAME}

  nginx:
    image: nginx:alpine
    container_name: ${PREFIX_NAME}-nginx
    restart: unless-stopped
    ports:
      - ${NGINX_PORT}:80
    volumes:
      - ./src:/var/www
      - ./supports/nginx:/etc/nginx/conf.d
    networks:
      - ${RED_NAME}
    depends_on:
      - php
      - mysql
      - postgres

  postgres:
    image: postgres:12-alpine
    container_name: ${PREFIX_NAME}-postgres12
    #tty: true
    restart: always
    networks:
      - ${RED_NAME}
    ports:
      - ${PG_PORT}:5432
    volumes:
      - ./supports/postgres/dbdata:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: ${PG_USR_NAME}
      POSTGRES_PASSWORD: ${PG_USR_PASS}
      POSTGRES_DB: ${PG_DB}

networks:
  multi-red:
    driver: bridge
